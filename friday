#!/bin/bash
# Friday AI - Convenience CLI

FRIDAY_DIR="/home/artur/friday"

case "$1" in
    status)
        echo "üìä Friday AI System Status"
        echo "=========================="
        systemctl status vllm.service friday.service telegram-bot.service homelab-monitor.service --no-pager 2>/dev/null | grep -E "(‚óè|Active:)"
        ;;
    
    logs)
        SERVICE="${2:-friday}"
        tail -f "$FRIDAY_DIR/logs/${SERVICE}.log"
        ;;
    
    notify)
        shift
        MESSAGE="$1"
        SEVERITY="${2:-info}"
        cd "$FRIDAY_DIR"
        bash scripts/monitoring/send_notification.sh "$MESSAGE" "$SEVERITY"
        ;;
    
    report)
        cd "$FRIDAY_DIR"
        bash scripts/monitoring/status_report.sh
        ;;
    
    test)
        TEST_TYPE="${2:-all}"
        cd "$FRIDAY_DIR"
        
        case "$TEST_TYPE" in
            unit)
                echo "Running unit tests..."
                pipenv run pytest -m unit tests/
                ;;
            integration)
                echo "Running integration tests..."
                pipenv run pytest -m integration tests/
                ;;
            bash)
                echo "Running bash test script..."
                bash scripts/testing/test_friday.sh
                ;;
            all|*)
                echo "Running all pytest tests..."
                pipenv run pytest tests/
                ;;
        esac
        ;;
    
    reminders)
        ACTION="${2:-list}"
        case "$ACTION" in
            list)
                echo "üìÖ Pending reminders:"
                python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.reminders import reminder_service
reminders = reminder_service.list_pending_reminders()
if not reminders:
    print('  No pending reminders')
else:
    for r in reminders:
        time_str = r.remind_at.strftime('%Y-%m-%d %H:%M:%S')
        print(f'  [{r.id[:8]}] {r.message}')
        print(f'    at {time_str}')
"
                ;;
            cancel)
                REMINDER_ID="$3"
                if [ -z "$REMINDER_ID" ]; then
                    echo "‚ùå Please provide a reminder ID"
                    echo "Usage: friday reminders cancel <id>"
                    exit 1
                fi
                python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.reminders import reminder_service
if reminder_service.cancel_reminder('$REMINDER_ID'):
    print('‚úÖ Reminder cancelled')
else:
    print('‚ùå Reminder not found')
"
                ;;
            *)
                echo "Usage: friday reminders [list|cancel]"
                echo ""
                echo "  list              List pending reminders"
                echo "  cancel <id>       Cancel a reminder"
                ;;
        esac
        ;;
    
    memory)
        ACTION="${2:-list}"
        API_KEY="${FRIDAY_API_KEY:-5b604c9f8e2d1be2978d91b51f2b3fe70b64f2b552cea1870e764dd6016c0de9}"
        
        case "$ACTION" in
            add)
                shift 2  # Remove 'memory' and 'add'
                CONTENT="$*"
                if [ -z "$CONTENT" ]; then
                    echo "‚ùå Please provide content to remember"
                    echo "Usage: friday memory add <text>"
                    exit 1
                fi
                echo "üíæ Saving memory..."
                curl -s -X POST -H "X-API-Key: $API_KEY" \
                    -H "Content-Type: application/json" \
                    -d "{\"content\": \"$CONTENT\", \"tags\": [\"cli\"]}" \
                    http://localhost:8080/remember | python3 -m json.tool
                ;;
            list)
                echo "üìù Listing memories..."
                curl -s -H "X-API-Key: $API_KEY" \
                    http://localhost:8080/admin/memories | python3 -m json.tool
                ;;
            delete)
                MEMORY_ID="$3"
                if [ -z "$MEMORY_ID" ]; then
                    echo "‚ùå Please provide a memory ID"
                    echo "Usage: friday memory delete <memory_id>"
                    exit 1
                fi
                echo "üóëÔ∏è  Deleting memory: $MEMORY_ID"
                curl -s -X DELETE -H "X-API-Key: $API_KEY" \
                    "http://localhost:8080/admin/memories/$MEMORY_ID" | python3 -m json.tool
                ;;
            clear)
                echo "‚ö†Ô∏è  This will delete ALL memories!"
                read -p "Are you sure? (y/n): " -n 1 -r
                echo
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                    echo "üóëÔ∏è  Clearing all memories..."
                    curl -s -X DELETE -H "X-API-Key: $API_KEY" \
                        http://localhost:8080/admin/memories | python3 -m json.tool
                else
                    echo "Cancelled."
                fi
                ;;
            drop-all)
                echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è  DANGER: This will delete ALL memories AND chat history!"
                echo "This includes:"
                echo "  - Explicit memories (/remember entries)"
                echo "  - All chat conversation history"
                echo "  - Everything in ChromaDB memory collection"
                echo ""
                read -p "Type 'DELETE ALL' to confirm: " -r
                echo
                if [[ $REPLY == "DELETE ALL" ]]; then
                    echo "üóëÔ∏è  Dropping entire memory collection..."
                    curl -s -X DELETE -H "X-API-Key: $API_KEY" \
                        http://localhost:8080/admin/memories/all | python3 -m json.tool
                    
                    # Also clean up memory files
                    if [ -d "$FRIDAY_DIR/data/memory" ]; then
                        echo "üóëÔ∏è  Cleaning up memory files..."
                        rm -rf "$FRIDAY_DIR/data/memory"/*
                        echo "‚úÖ Memory files cleaned"
                    fi
                else
                    echo "Cancelled."
                fi
                ;;
            *)
                echo "Usage: friday memory [add|list|delete|clear|drop-all]"
                echo ""
                echo "  add <text>        Create a new memory"
                echo "  list              List explicit memories only"
                echo "  delete <id>       Delete specific memory"
                echo "  clear             Clear all explicit memories"
                echo "  drop-all          Delete EVERYTHING (explicit + chat history)"
                ;;
        esac
        ;;
    
    index)
        ACTION="${2:-status}"
        cd "$FRIDAY_DIR"
        
        case "$ACTION" in
            rebuild)
                echo "üîÑ Rebuilding RAG index..."
                echo "   Source: ~/friday/brain/1. Notes/"
                echo ""
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.vector_store import vector_store
from app.core.config import settings

print(f'üìÅ Indexing documents from: {settings.vault_path}')
print('')

count = vector_store.rebuild_index()

print('')
print(f'‚úÖ Index rebuilt: {count} chunks indexed')
"
                ;;
            status)
                echo "üìä RAG Index Status"
                echo "==================="
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.vector_store import vector_store
from app.services.memory_store import MemoryStore
from app.core.config import settings
from pathlib import Path

# Count source files
vault_files = list(settings.vault_path.rglob('*.md'))

# Count brain memories
memory_store = MemoryStore()
brain_memories = memory_store.count()

# Count other brain folders
journal_files = list(settings.journal_path.glob('*.md')) if settings.journal_path.exists() else []
report_files = list(settings.reports_path.glob('*.md')) if settings.reports_path.exists() else []
reminder_files = list(settings.reminders_path.glob('*.json')) if settings.reminders_path.exists() else []

stats = vector_store.get_stats()

print(f'üìÅ Brain folder: {settings.brain_path}')
print(f'')
print(f'üìö Vault (1. Notes):')
print(f'   Files: {len(vault_files)}')
print(f'   Indexed chunks: {stats[\"obsidian_chunks\"]}')
print(f'')
print(f'üß† Friday (5. Friday):')
print(f'   Memories: {brain_memories}')
print(f'   Journal entries: {len(journal_files)}')
print(f'   Reports: {len(report_files)}')
print(f'   Reminders: {len(reminder_files)}')
print(f'')
print(f'üíæ ChromaDB entries: {stats[\"memory_entries\"]}')
"
                ;;
            *)
                echo "Usage: friday index [rebuild|status]"
                echo ""
                echo "  status    Show index statistics (default)"
                echo "  rebuild   Rebuild the entire RAG index"
                ;;
        esac
        ;;
    
    monitor)
        cd "$FRIDAY_DIR"
        bash scripts/monitoring/monitor.sh
        ;;
    
    sync)
        cd "$FRIDAY_DIR"
        bash scripts/system/sync_nextcloud.sh
        ;;
    
    restart)
        SERVICE="${2:-all}"
        if [ "$SERVICE" = "all" ]; then
            echo "üîÑ Restarting all services..."
            sudo systemctl restart vllm.service friday.service telegram-bot.service homelab-monitor.service
            echo "‚úÖ All services restarted!"
        elif [[ "$SERVICE" == *","* ]]; then
            # Handle comma-separated services
            IFS=',' read -ra SERVICES <<< "$SERVICE"
            echo "üîÑ Restarting services: ${SERVICES[*]}..."
            SERVICE_LIST=""
            for svc in "${SERVICES[@]}"; do
                SERVICE_LIST="$SERVICE_LIST ${svc}.service"
            done
            sudo systemctl restart $SERVICE_LIST
            echo "‚úÖ Services restarted: ${SERVICES[*]}"
        else
            echo "üîÑ Restarting ${SERVICE}.service..."
            sudo systemctl restart "${SERVICE}.service"
            echo "‚úÖ ${SERVICE}.service restarted!"
        fi
        ;;
    
    install-services)
        echo "üì¶ Installing Friday AI services..."
        echo ""
        
        # Copy service files
        echo "Copying service files to /etc/systemd/system/..."
        sudo cp "$FRIDAY_DIR/services/"*.service /etc/systemd/system/
        
        # Reload systemd
        echo "Reloading systemd daemon..."
        sudo systemctl daemon-reload
        
        # Enable services
        echo "Enabling services to start on boot..."
        sudo systemctl enable vllm.service
        sudo systemctl enable friday.service
        sudo systemctl enable telegram-bot.service
        
        # Ask about homelab-monitor
        echo ""
        read -p "Enable homelab monitoring service? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            sudo systemctl enable homelab-monitor.service
            echo "‚úÖ Homelab monitor enabled"
        fi
        
        echo ""
        echo "‚úÖ Services installed and enabled!"
        echo ""
        echo "To start services now, run:"
        echo "  friday restart all"
        echo ""
        echo "Or start individually:"
        echo "  sudo systemctl start vllm.service"
        echo "  sudo systemctl start friday.service"
        echo "  sudo systemctl start telegram-bot.service"
        ;;
    
    uninstall-services)
        echo "üóëÔ∏è  Uninstalling Friday AI services..."
        echo ""
        
        read -p "Are you sure you want to stop and disable all services? (y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            exit 0
        fi
        
        # Stop services
        echo "Stopping services..."
        sudo systemctl stop vllm.service friday.service telegram-bot.service homelab-monitor.service 2>/dev/null
        
        # Disable services
        echo "Disabling services..."
        sudo systemctl disable vllm.service friday.service telegram-bot.service homelab-monitor.service 2>/dev/null
        
        # Remove service files
        echo "Removing service files..."
        sudo rm -f /etc/systemd/system/vllm.service
        sudo rm -f /etc/systemd/system/friday.service
        sudo rm -f /etc/systemd/system/telegram-bot.service
        sudo rm -f /etc/systemd/system/homelab-monitor.service
        
        # Reload systemd
        echo "Reloading systemd daemon..."
        sudo systemctl daemon-reload
        
        echo ""
        echo "‚úÖ Services uninstalled!"
        ;;
    
    awareness)
        ACTION="${2:-check}"
        cd "$FRIDAY_DIR"
        
        case "$ACTION" in
            check)
                echo "üß† Running Awareness Engine checks (dry run)..."
                echo ""
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.awareness_engine import awareness_engine

alerts = awareness_engine.run_all_checks()

if not alerts:
    print('‚úÖ No alerts generated')
else:
    print(f'üì¢ {len(alerts)} alert(s) would be generated:')
    print('')
    for i, alert in enumerate(alerts, 1):
        priority_emoji = {'urgent': 'üö®', 'high': '‚ö†Ô∏è', 'medium': 'üì¢', 'low': 'üí°'}.get(alert.priority.value, 'üì¢')
        print(f'{i}. {priority_emoji} [{alert.priority.value.upper()}] {alert.title}')
        print(f'   Category: {alert.category}')
        print(f'   {alert.message[:100]}...' if len(alert.message) > 100 else f'   {alert.message}')
        print('')
"
                ;;
            run)
                echo "üß† Running Awareness Engine checks and sending alerts..."
                echo ""
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.awareness_engine import awareness_engine

awareness_engine.check_and_notify()
print('‚úÖ Done')
"
                ;;
            budget)
                echo "üìä Reach-Out Budget Status"
                echo "=========================="
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.awareness_engine import awareness_engine

stats = awareness_engine.get_budget_stats()
print(f'Date: {stats.get(\"date\", \"N/A\")}')
print(f'Messages sent: {stats.get(\"messages_sent\", 0)}/5')
print(f'Remaining budget: {stats.get(\"remaining\", 0)}')
print(f'User responses: {stats.get(\"user_responses\", 0)}')
print(f'Ignored: {stats.get(\"ignored\", 0)}')
print(f'Skipped alerts: {stats.get(\"skipped_count\", 0)}')
"
                ;;
            skipped)
                echo "‚è≠Ô∏è  Skipped Alerts (due to budget)"
                echo "==================================="
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.awareness_engine import awareness_engine

skipped = awareness_engine.get_skipped_alerts()
if not skipped:
    print('No alerts were skipped today.')
else:
    for i, alert in enumerate(skipped, 1):
        print(f'{i}. [{alert.get(\"priority\", \"?\")}] {alert.get(\"title\", \"Untitled\")}')
        print(f'   {alert.get(\"message\", \"\")[:80]}...')
        print(f'   Skipped at: {alert.get(\"skipped_at\", \"?\")[:16]}')
        print('')
"
                ;;
            patterns)
                echo "üìà Detected Behavioral Patterns"
                echo "==============================="
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.awareness_engine import awareness_engine

patterns = awareness_engine.get_patterns()

print('üõèÔ∏è  Sleep:')
print(f'   Consistency score: {patterns[\"sleep\"][\"consistency_score\"]:.0f}/100')
print('')
print('üèÉ Workouts:')
print(f'   Average per week: {patterns[\"workouts\"][\"avg_per_week\"]:.1f}')
print(f'   Typical days: {patterns[\"workouts\"][\"typical_days\"] or \"Not enough data\"}')
print(f'   Days since last: {patterns[\"workouts\"][\"days_since_last\"]}')
print(f'   Last workout: {patterns[\"workouts\"][\"last_workout_date\"] or \"Unknown\"}')
print('')
print(f'Last updated: {patterns[\"last_updated\"] or \"Never\"}')
"
                ;;
            update-patterns)
                echo "üîÑ Updating behavioral patterns..."
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.awareness_engine import awareness_engine

awareness_engine.update_patterns()
print('‚úÖ Patterns updated')
"
                ;;
            ack)
                ALERT_KEY="$3"
                if [ -z "$ALERT_KEY" ]; then
                    echo "Usage: friday awareness ack <alert_key>"
                    exit 1
                fi
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.awareness_engine import awareness_engine

awareness_engine.acknowledge_alert('$ALERT_KEY')
print('‚úÖ Alert acknowledged: $ALERT_KEY')
"
                ;;
            infra)
                echo "üñ•Ô∏è  Infrastructure Status"
                echo "========================="
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.awareness_engine import awareness_engine

status = awareness_engine.get_infrastructure_status()

print(f'Checked at: {status[\"checked_at\"][:19]}')
print('')

# Disk
disk = status.get('disk', {})
if 'error' not in disk:
    bar_len = 20
    used_pct = disk.get('percent_used', 0)
    filled = int(bar_len * used_pct / 100)
    bar = '‚ñà' * filled + '‚ñë' * (bar_len - filled)
    print(f'üíæ Disk /:')
    print(f'   [{bar}] {used_pct:.1f}%')
    print(f'   {disk.get(\"used_gb\", 0):.1f} GB used / {disk.get(\"total_gb\", 0):.1f} GB total')
    print(f'   {disk.get(\"free_gb\", 0):.1f} GB free')
else:
    print(f'üíæ Disk: Error - {disk[\"error\"]}')
print('')

# CPU Temp
temp = status.get('cpu_temp')
if temp:
    if temp > 75:
        emoji = 'üî¥'
    elif temp > 60:
        emoji = 'üü°'
    else:
        emoji = 'üü¢'
    print(f'üå°Ô∏è  CPU Temperature: {emoji} {temp:.1f}¬∞C')
else:
    print('üå°Ô∏è  CPU Temperature: N/A')
print('')

# Services
print('üîß Services:')
services = status.get('services', {})
for svc, svc_status in services.items():
    emoji = '‚úÖ' if svc_status == 'active' else '‚ùå'
    print(f'   {emoji} {svc}: {svc_status}')
"
                ;;
            *)
                echo "Usage: friday awareness [check|run|budget|skipped|patterns|update-patterns|ack|infra]"
                echo ""
                echo "  check              Run all checks (dry run - no alerts sent)"
                echo "  run                Run checks and send alerts"
                echo "  budget             Show reach-out budget status"
                echo "  skipped            List alerts skipped due to budget"
                echo "  patterns           Show detected behavioral patterns"
                echo "  update-patterns    Update pattern data from recent activity"
                echo "  ack <key>          Acknowledge an alert"
                echo "  infra              Show infrastructure status"
                echo ""
                echo "Examples:"
                echo "  friday awareness check     # See what alerts would be generated"
                echo "  friday awareness infra     # Check disk, CPU, services"
                echo "  friday awareness patterns  # See sleep/workout patterns"
                ;;
        esac
        ;;
    
    chat)
        ACTION="${2:-help}"
        cd "$FRIDAY_DIR"
        
        case "$ACTION" in
            intent)
                shift 2
                MESSAGE="$*"
                if [ -z "$MESSAGE" ]; then
                    echo "Usage: friday chat intent \"<message>\""
                    echo ""
                    echo "Example:"
                    echo "  friday chat intent \"Set a reminder for tomorrow and check my calendar\""
                    exit 1
                fi
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.intent.router import intent_router
import json

message = '''$MESSAGE'''
intent = intent_router.route(message)

print('Message:', message[:80] + '...' if len(message) > 80 else message)
print('')
print('Detected intent:')
print(json.dumps(intent, indent=2, default=str))
"
                ;;
            handlers)
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.chat import handler_registry

handlers = handler_registry.list_handlers()
print(f'Registered handlers: {len(handlers)}')
print('')
for action, handler in sorted(handlers.items()):
    print(f'  {action}: {handler}')
"
                ;;
            test)
                shift 2
                MESSAGE="$*"
                if [ -z "$MESSAGE" ]; then
                    echo "Usage: friday chat test \"<message>\""
                    echo ""
                    echo "Example:"
                    echo "  friday chat test \"What's on my calendar?\""
                    exit 1
                fi
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.chat import chat_service
import json

message = '''$MESSAGE'''
result = chat_service.chat(message)

print('Message:', message)
print('')
print('Response:')
print(result.get('answer', '(no answer)'))
print('')
print('Metadata:')
print(f'  session_id: {result.get(\"session_id\", \"N/A\")}')
print(f'  used_rag: {result.get(\"used_rag\", False)}')
print(f'  used_web: {result.get(\"used_web\", False)}')
print(f'  used_memory: {result.get(\"used_memory\", False)}')
print(f'  used_health: {result.get(\"used_health\", False)}')
"
                ;;
            *)
                echo "Usage: friday chat [intent|handlers|test]"
                echo ""
                echo "  intent \"<msg>\"    Test the intent router with a message"
                echo "  handlers          List all registered intent handlers"
                echo "  test \"<msg>\"      Send a test message to the chat service"
                echo ""
                echo "Examples:"
                echo "  friday chat intent \"remind me to call mom in 30 minutes\""
                echo "  friday chat handlers"
                echo "  friday chat test \"What's on my calendar today?\""
                ;;
        esac
        ;;
    
    config)
        ACTION="${2:-show}"
        cd "$FRIDAY_DIR"
        
        case "$ACTION" in
            show)
                echo "üìã Friday Configuration"
                echo "======================="
                echo ""
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.core.config import settings, YAML_CONFIG, PROJECT_ROOT
import os

def mask_secret(value):
    if value and len(str(value)) > 8:
        s = str(value)
        return s[:4] + '****' + s[-4:]
    return '****' if value else '(not set)'

print('üìÅ Paths:')
print(f'   root:   {settings.paths.root}')
print(f'   brain:  {settings.paths.brain}')
print(f'   data:   {settings.paths.data}')
print(f'   logs:   {settings.paths.logs}')
print(f'   config: {settings.paths.config}')
print('')
print('üë§ User:')
print(f'   name:     {settings.user.name}')
print(f'   timezone: UTC{settings.user.timezone_offset_hours:+d}')
print('')
print('ü§ñ LLM:')
print(f'   base_url:    {settings.llm.base_url}')
print(f'   model:       {settings.llm.model_name}')
print(f'   temperature: {settings.llm.temperature}')
print('')
print('üîó Services:')
print(f'   friday_api: {settings.services.friday_api_url}')
print(f'   searxng:    {settings.services.searxng_url}')
print(f'   whisper:    {settings.services.whisper_url or \"(not set)\"}')
print('')
print('üîê Auth (masked):')
print(f'   api_key:       {mask_secret(settings.auth.api_key)}')
print(f'   telegram_token: {mask_secret(settings.telegram.bot_token)}')
print(f'   weather_key:   {mask_secret(settings.weather.api_key)}')
print('')
print('üéõÔ∏è  Features:')
print(f'   web_search:        {settings.features.web_search}')
print(f'   health_monitoring: {settings.features.health_monitoring}')
print(f'   calendar:          {settings.features.calendar_integration}')
print(f'   proactive_alerts:  {settings.features.proactive_alerts}')
print(f'   learning_system:   {settings.features.learning_system}')
print('')
print('üìÑ Config sources:')
config_yml = PROJECT_ROOT / 'config.yml'
print(f'   config.yml: {\"‚úÖ loaded\" if config_yml.exists() else \"‚ùå not found\"}')
print(f'   .env:       {\"‚úÖ loaded\" if (PROJECT_ROOT / \".env\").exists() else \"‚ö™ not found\"}')
"
                ;;
            validate)
                echo "üîç Validating Configuration..."
                echo ""
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.core.config import settings, PROJECT_ROOT
import requests

errors = []
warnings = []

# Check paths exist
print('üìÅ Checking paths...')
paths_to_check = [
    ('root', settings.paths.root),
    ('brain', settings.paths.brain),
    ('data', settings.paths.data),
    ('logs', settings.paths.logs),
    ('config', settings.paths.config),
    ('vault', settings.vault_path),
]
for name, path in paths_to_check:
    if path.exists():
        print(f'   ‚úÖ {name}: {path}')
    else:
        print(f'   ‚ùå {name}: {path} (MISSING)')
        errors.append(f'Path {name} does not exist: {path}')

print('')
print('üîó Checking services...')

# Check LLM
try:
    r = requests.get(f'{settings.llm.base_url}/models', timeout=5)
    if r.status_code == 200:
        models = r.json().get('data', [])
        model_ids = [m['id'] for m in models]
        if settings.llm.model_name in model_ids:
            print(f'   ‚úÖ LLM: {settings.llm.model_name}')
        else:
            print(f'   ‚ö†Ô∏è  LLM: configured model \"{settings.llm.model_name}\" not in available models: {model_ids}')
            warnings.append(f'LLM model mismatch')
    else:
        print(f'   ‚ùå LLM: not responding (status {r.status_code})')
        errors.append('LLM service not responding')
except Exception as e:
    print(f'   ‚ùå LLM: connection failed ({e})')
    errors.append(f'LLM connection failed: {e}')

# Check Friday API
try:
    r = requests.get(f'{settings.services.friday_api_url}/health', timeout=5)
    if r.status_code == 200:
        print(f'   ‚úÖ Friday API: {settings.services.friday_api_url}')
    else:
        print(f'   ‚ö†Ô∏è  Friday API: status {r.status_code}')
        warnings.append('Friday API returned non-200')
except Exception as e:
    print(f'   ‚ùå Friday API: connection failed')
    errors.append(f'Friday API not reachable')

# Check SearXNG
try:
    r = requests.get(f'{settings.services.searxng_url}', timeout=5)
    if r.status_code == 200:
        print(f'   ‚úÖ SearXNG: {settings.services.searxng_url}')
    else:
        print(f'   ‚ö†Ô∏è  SearXNG: status {r.status_code}')
        warnings.append('SearXNG returned non-200')
except Exception as e:
    print(f'   ‚ö†Ô∏è  SearXNG: not reachable (optional)')
    warnings.append('SearXNG not reachable')

print('')
print('üîê Checking credentials...')
if settings.auth.api_key:
    print('   ‚úÖ API key: configured')
else:
    print('   ‚ö†Ô∏è  API key: not set')
    warnings.append('API key not configured')

if settings.telegram.bot_token:
    print('   ‚úÖ Telegram token: configured')
else:
    print('   ‚ö†Ô∏è  Telegram token: not set')
    warnings.append('Telegram bot token not configured')

print('')
if errors:
    print(f'‚ùå Validation failed with {len(errors)} error(s)')
    for e in errors:
        print(f'   ‚Ä¢ {e}')
elif warnings:
    print(f'‚ö†Ô∏è  Validation passed with {len(warnings)} warning(s)')
else:
    print('‚úÖ All checks passed!')
"
                ;;
            source)
                KEY="$3"
                if [ -z "$KEY" ]; then
                    echo "Usage: friday config source <key>"
                    echo ""
                    echo "Examples:"
                    echo "  friday config source llm.model_name"
                    echo "  friday config source user.name"
                    echo "  friday config source paths.brain"
                    exit 1
                fi
                pipenv run python3 -c "
import sys
import os
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.core.config import settings, YAML_CONFIG, _get_nested, get_config_source

key = '$KEY'
parts = key.split('.')

# Get the value from settings
obj = settings
for part in parts:
    if hasattr(obj, part):
        obj = getattr(obj, part)
    else:
        print(f'‚ùå Key not found: {key}')
        sys.exit(1)

source = get_config_source(key)
source_label = {
    'env': 'üåç Environment variable',
    'yaml': 'üìÑ config.yml',
    'default': '‚öôÔ∏è  Default value'
}.get(source, source)

print(f'{key} = {obj}')
print(f'Source: {source_label}')
"
                ;;
            *)
                echo "Usage: friday config [show|validate|source]"
                echo ""
                echo "  show              Show current configuration (secrets masked)"
                echo "  validate          Validate config and check service connectivity"
                echo "  source <key>      Show where a config value comes from"
                echo ""
                echo "Examples:"
                echo "  friday config show"
                echo "  friday config validate"
                echo "  friday config source llm.model_name"
                ;;
        esac
        ;;
    
    feedback)
        ACTION="${2:-stats}"
        cd "$FRIDAY_DIR"
        
        case "$ACTION" in
            stats)
                echo "üìä Feedback Statistics"
                echo "======================"
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.feedback_store import get_feedback_store

store = get_feedback_store()
stats = store.get_feedback_stats(days=30)

overall = stats['overall']
print(f'Last 30 days:')
print(f'  Total responses rated: {overall[\"total\"]}')
print(f'  üëç Thumbs up: {overall[\"thumbs_up\"]}')
print(f'  üëé Thumbs down: {overall[\"thumbs_down\"]}')
print(f'  Approval rate: {overall[\"approval_rate\"]}%')
print('')

if stats['by_intent']:
    print('By Intent:')
    for item in stats['by_intent'][:10]:
        print(f'  {item[\"intent\"]}: {item[\"approval_rate\"]}% ({item[\"total\"]} ratings)')
"
                ;;
            negative)
                LIMIT="${3:-10}"
                echo "üëé Recent Negative Feedback"
                echo "==========================="
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.feedback_store import get_feedback_store

store = get_feedback_store()
negative = store.get_recent_negative_with_corrections(limit=$LIMIT)

if not negative:
    print('No negative feedback found')
else:
    for item in negative:
        print(f'[{item[\"id\"]}] {item[\"timestamp\"][:16]}')
        print(f'  User: {item[\"user_message\"][:80]}...' if len(item['user_message'] or '') > 80 else f'  User: {item[\"user_message\"]}')
        print(f'  Intent: {item.get(\"intent_action\", \"unknown\")}')
        if item.get('correction'):
            print(f'  ‚úèÔ∏è  Correction: {item[\"correction\"]}')
        print('')
"
                ;;
            corrections)
                echo "üìù Pending Corrections"
                echo "======================"
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.feedback_store import get_feedback_store

store = get_feedback_store()
corrections = store.get_unprocessed_corrections(limit=50)

if not corrections:
    print('No pending corrections to process')
else:
    print(f'{len(corrections)} correction(s) awaiting synthesis:')
    print('')
    for c in corrections:
        print(f'[{c[\"correction_id\"]}] {c[\"correction_time\"][:16]}')
        print(f'  Original: {c[\"user_message\"][:60]}...' if len(c['user_message']) > 60 else f'  Original: {c[\"user_message\"]}')
        print(f'  Correction: {c[\"correction_text\"]}')
        print(f'  Intent: {c.get(\"intent_action\", \"unknown\")}')
        print('')
"
                ;;
            alert-stats)
                echo "üì¢ Alert Feedback Statistics"
                echo "============================="
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.awareness_engine import awareness_engine

stats = awareness_engine.get_alert_feedback_stats()

print(f'Total feedback received: {stats[\"total_feedback\"]}')
print(f'  üëç Thumbs up: {stats[\"thumbs_up\"]}')
print(f'  üëé Thumbs down: {stats[\"thumbs_down\"]}')
print(f'  Quality score: {stats[\"quality_score\"]*100:.1f}%')
print('')

if stats['by_category']:
    print('By Alert Category:')
    for cat, data in stats['by_category'].items():
        total = data['up'] + data['down']
        pct = (data['up'] / total * 100) if total > 0 else 0
        print(f'  {cat}: {pct:.0f}% approval ({total} ratings)')
"
                ;;
            *)
                echo "Usage: friday feedback [stats|negative|corrections|alert-stats]"
                echo ""
                echo "  stats             Show feedback statistics (last 30 days)"
                echo "  negative [n]      List recent negative feedback (default: 10)"
                echo "  corrections       List pending corrections awaiting synthesis"
                echo "  alert-stats       Show proactive alert feedback stats"
                echo ""
                echo "Examples:"
                echo "  friday feedback stats"
                echo "  friday feedback negative 20"
                echo "  friday feedback corrections"
                ;;
        esac
        ;;
    
    learn)
        ACTION="${2:-list}"
        cd "$FRIDAY_DIR"
        
        case "$ACTION" in
            synthesize)
                echo "üß† Running Learning Synthesis..."
                echo "================================"
                pipenv run python3 -c "
import sys
import asyncio
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.learning_service import get_learning_service
from app.services.feedback_store import get_feedback_store

store = get_feedback_store()
corrections = store.get_unprocessed_corrections(limit=50)
print(f'Found {len(corrections)} unprocessed corrections')

if not corrections:
    print('No corrections to synthesize')
    sys.exit(0)

service = get_learning_service()
new_learnings = asyncio.run(service.synthesize_learnings())

if not new_learnings:
    print('No new learnings generated (corrections may not show clear patterns)')
else:
    print(f'Generated {len(new_learnings)} new learnings:')
    for learning in new_learnings:
        print(f'')
        print(f'  [{learning.confidence:.2f}] {learning.pattern}')
        print(f'       ‚Üí {learning.prompt_adjustment}')
"
                ;;
            list)
                echo "üìö Active Learnings"
                echo "==================="
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.learning_service import get_learning_service

service = get_learning_service()
learnings = service.get_all_learnings()

if not learnings:
    print('No learnings yet. Learnings are generated from user feedback.')
    print('')
    print('To generate learnings:')
    print('  1. Give feedback on responses (üëç/üëé in Telegram)')
    print('  2. Provide corrections when prompted after üëé')
    print('  3. Run: friday learn synthesize')
else:
    print(f'System is {\"ENABLED\" if service.is_enabled() else \"DISABLED\"}')
    print('')
    print(f'ID              Conf   Category   Pattern')
    print(f'‚îÄ' * 60)
    for l in learnings:
        status = '‚úì' if l.active else '‚óã'
        print(f'{status} {l.id[:15]:<15} {l.confidence:.2f}   {l.category:<10} {l.pattern[:30]}...' if len(l.pattern) > 30 else f'{status} {l.id[:15]:<15} {l.confidence:.2f}   {l.category:<10} {l.pattern}')
"
                ;;
            show)
                LEARNING_ID="$3"
                if [ -z "$LEARNING_ID" ]; then
                    echo "Usage: friday learn show <learning_id>"
                    exit 1
                fi
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.learning_service import get_learning_service

service = get_learning_service()
learning = service.get_learning('$LEARNING_ID')

if not learning:
    print(f'Learning not found: $LEARNING_ID')
    sys.exit(1)

print(f'ID: {learning.id}')
print(f'Created: {learning.created_at}')
print(f'Category: {learning.category}')
print(f'Confidence: {learning.confidence:.2f}')
print(f'Active: {\"Yes\" if learning.active else \"No\"}')
print('')
print(f'Pattern: {learning.pattern}')
print('')
print(f'Prompt Adjustment:')
print(f'  {learning.prompt_adjustment}')
print('')
print(f'Source corrections: {learning.source_corrections}')
"
                ;;
            add)
                shift 2
                LEARNING_TEXT="$*"
                if [ -z "$LEARNING_TEXT" ]; then
                    echo "Usage: friday learn add \"<preference or instruction>\""
                    echo ""
                    echo "Examples:"
                    echo "  friday learn add \"Always respond in Portuguese when I write in Portuguese\""
                    echo "  friday learn add \"Keep responses under 3 paragraphs\""
                    exit 1
                fi
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.learning_service import get_learning_service

service = get_learning_service()
learning = service.add_manual_learning(
    pattern='User preference (manually added)',
    prompt_adjustment='''$LEARNING_TEXT''',
    confidence=1.0,
    category='manual'
)

print(f'‚úÖ Learning added: {learning.id}')
print(f'   {learning.prompt_adjustment}')
"
                ;;
            remove)
                LEARNING_ID="$3"
                if [ -z "$LEARNING_ID" ]; then
                    echo "Usage: friday learn remove <learning_id>"
                    exit 1
                fi
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.learning_service import get_learning_service

service = get_learning_service()
if service.remove_learning('$LEARNING_ID'):
    print(f'‚úÖ Removed learning: $LEARNING_ID')
else:
    print(f'‚ùå Learning not found: $LEARNING_ID')
"
                ;;
            disable)
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.learning_service import get_learning_service

service = get_learning_service()
service.disable_all()
print('‚úÖ Learning system DISABLED')
print('   Learnings will not be applied to prompts')
"
                ;;
            enable)
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.learning_service import get_learning_service

service = get_learning_service()
service.enable_all()
print('‚úÖ Learning system ENABLED')
print('   Learnings will be applied to prompts')
"
                ;;
            stats)
                pipenv run python3 -c "
import sys
sys.path.insert(0, '$FRIDAY_DIR/src')
from app.services.learning_service import get_learning_service

service = get_learning_service()
stats = service.get_stats()

print(f'Learning System: {\"ENABLED\" if stats[\"enabled\"] else \"DISABLED\"}')
print(f'Total learnings: {stats[\"total_learnings\"]}')
print(f'Active learnings: {stats[\"active_learnings\"]}')
print(f'Average confidence: {stats[\"avg_confidence\"]*100:.1f}%')
print('')
if stats['by_category']:
    print('By category:')
    for cat, count in stats['by_category'].items():
        print(f'  {cat}: {count}')
"
                ;;
            *)
                echo "Usage: friday learn [synthesize|list|show|add|remove|disable|enable|stats]"
                echo ""
                echo "  synthesize         Run learning synthesis from pending corrections"
                echo "  list               List all learnings"
                echo "  show <id>          Show details of a specific learning"
                echo "  add \"<text>\"       Manually add a learning/preference"
                echo "  remove <id>        Remove a learning"
                echo "  disable            Disable the learning system"
                echo "  enable             Enable the learning system"
                echo "  stats              Show learning system statistics"
                echo ""
                echo "Examples:"
                echo "  friday learn list"
                echo "  friday learn synthesize"
                echo "  friday learn add \"Always use bullet points for lists\""
                echo "  friday learn show learn_20251205_001"
                echo "  friday learn remove learn_20251205_001"
                ;;
        esac
        ;;
    
    *)
        cat << 'HELP'
Friday AI - CLI Tool

Usage: friday <command> [options]

Commands:
   status                  Show status of all services
   logs [service]          Tail logs (friday|vllm|telegram_bot|homelab_monitor)
   notify "msg" [sev]      Send notification (severity: info|warning|error|success|critical)
   report                  Send system status report via Telegram
   test [type]             Run tests (all|unit|integration|bash)
   chat [action]           Chat debugging (intent|handlers|test)
   awareness [action]      Awareness engine (check|run|budget|patterns|infra)
   feedback [action]       Feedback system (stats|negative|corrections|alert-stats)
   learn [action]          Learning system (synthesize|list|add|remove|enable|disable)
   config [action]         Manage configuration (show|validate|source)
   index [action]          Manage RAG index (status|rebuild)
   reminders [action]      Manage reminders (list|cancel <id>)
   memory [action]         Manage memories (add|list|delete|clear|drop-all)
   monitor                 Show system monitor
   sync                    Sync Nextcloud and reindex
   restart [service]       Restart service(s) (all|friday,telegram-bot|service1,service2)
   install-services        Install and enable all systemd services
   uninstall-services      Stop, disable, and remove all services

Examples:
  friday status
  friday logs friday
  friday notify "Backup complete!" success
  friday report
  friday test              # Run all tests
  friday test unit         # Run only unit tests
  friday test integration  # Run only integration tests
  friday index status      # Show index stats
  friday index rebuild     # Rebuild RAG index from brain/1. Notes/
  friday reminders list
  friday reminders cancel abc12345
  friday memory add "I love pizza"
  friday memory list
  friday memory delete abc123
  friday memory clear
  friday memory drop-all
  friday restart friday,telegram-bot
  friday install-services
  friday config show           # Show current configuration
  friday config validate       # Validate config and services
  friday config source llm.model_name  # Check config source
  friday chat intent "remind me to buy milk"  # Test intent router
  friday chat handlers         # List all intent handlers
  friday chat test "What time is it?"  # Test the chat service
  friday feedback stats        # View feedback statistics
  friday feedback corrections  # List pending corrections
  friday learn list            # List active learnings
  friday learn synthesize      # Generate learnings from corrections
  friday learn add "Keep responses brief"  # Add a manual learning

HELP
        ;;
esac
